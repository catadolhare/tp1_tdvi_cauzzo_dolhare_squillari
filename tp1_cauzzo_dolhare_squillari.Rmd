---
title: "TP1"
author: "Catalina Dolhare, Camila Cauzzo, Renata Squillari"
date: "`r Sys.Date()`"
output:
  word_document: default
  pdf_document: default
---

**1. Introducción al problema**

El siguiente conjunto de datos presenta información acerca de una encuesta de satisfacción a pasageros de una cierta aerolinea. Obtuvimos este dataset de Kaggle, el cual cuenta con un conjunto de train con 104000 datos, representando el 80% del data set, y un conjunto de test con 26000 datos, representando el 20% del data set. Este data set cuenta con 23 variables, como "Type of travel", "Class", "Flight distance", "Departure Delay in Minutes", "Arrival Delay in Minutes". Principalmente, cuenta con "Satisfaction", variable categorica que puede tomar dos opciones: "Satisfaction" o "neutral or dissatisfaction".Con toda esta información, intentaremos predecir la satisfacción de un pasajero dado las respuesta a las variables.

-   Justificar la elección del conjunto de datos para el uso de árboles de decisión.

**2. Preparación de los datos**

```{r}
datos_train <- read.csv("train.csv")
datos_test <- read.csv("test.csv")
```

```{r}
datos<-rbind(datos_train, datos_test)
```

```{r}
set.seed(123)
sample_datos <- datos[sample(nrow(datos), 50000),]
nrow(sample_datos)
```

```{r}
sample_datos$satisfaction <- as.numeric(as.factor(sample_datos$satisfaction)) - 1
```

```{r}
summary(sample_datos)

```
A simple vista, vemos en la variable de satisfaction una mediana de 0 y una media 0.4338. Esto nos indica que hay mas pasajeros insatisfechos (0) que satisfechos (1).

```{r}
#install.packages("ggplot2")
library(ggplot2)
```

Para ver si las otras variables predictoras influyen en satisfacion hicimos una matriz de correlacion. Sabemos que correlacion no implica causalidad, no obstante, es bueno para visualizar y descartar variables que no influyen directamente en la satisfación de los pasajeros.
```{r, echo=FALSE}
#install.packages("corrplot")
library(corrplot)
numeric_data <- sample_datos[, sapply(sample_datos, is.numeric)]
cor_matrix <- cor(numeric_data)
corrplot(cor_matrix, method = "color", 
         tl.col = "black", tl.srt = 45, tl.cex = 0.5,  # Ajustes de etiquetas
         cl.ratio = 0.2,  # Ajustar el tamaño de las celdas
         addgrid.col = "black", # Añadir color a las líneas de la cuadrícula
         addCoef.col = "black",
         number.cex = 0.3)  
```
Se puede ver que hay algunas variables que no tienen correlación con la satisfación, y son "departure arrival time convenient", "gate of location", "departure delay in minutes", "departure arrival in minutes". Como no podemos descartar que no haya causalidad, analizamos estas variables para ver si inciden sobre la satisfación. 
```{r, echo=FALSE}
par(mfrow = c(1, 2), mar = c(5, 5, 4, 2), cex = 1.2)

# Filtrar los datos por nivel de satisfacción
delay_satisfecho <- sample_datos$Departure.Delay.in.Minutes[sample_datos$satisfaction == 1]
delay_insatisfecho <- sample_datos$Departure.Delay.in.Minutes[sample_datos$satisfaction == 0]

hist(delay_satisfecho, 
     probability = TRUE, 
     main = "Satisfechos", 
     xlab = "Departure Delay in Minutes", 
     xlim = c(0, max(sample_datos$Departure.Delay.in.Minutes, na.rm = TRUE)), 
     ylim = c(0, 0.04), 
     col = "red", 
     border = "black")

# Histograma para los clientes insatisfechos
hist(delay_insatisfecho, 
     probability = TRUE, 
     main = "Insatisfechos", 
     xlab = "Departure Delay in Minutes", 
     xlim = c(0, max(sample_datos$Departure.Delay.in.Minutes, na.rm = TRUE)), 
     ylim = c(0, 0.04), 
     col = "blue", 
     border = "black")
```

```{r, echo=FALSE}
par(mfrow = c(1, 2), mar = c(5, 5, 4, 2), cex = 1.2)

# Filtrar los datos por nivel de satisfacción
arrival_satisfecho <- sample_datos$Arrival.Delay.in.Minutes[sample_datos$satisfaction == 1]
arrival_insatisfecho <- sample_datos$Arrival.Delay.in.Minutes[sample_datos$satisfaction == 0]

hist(arrival_satisfecho, 
     probability = TRUE, 
     main = "Satisfechos", 
     xlab = "Arrival Delay in Minutes", 
     xlim = c(0, max(sample_datos$Arrival.Delay.in.Minutes, na.rm = TRUE)), 
     ylim = c(0, 0.04), 
     col = "red", 
     border = "black")

# Histograma para los clientes insatisfechos
hist(arrival_insatisfecho, 
     probability = TRUE, 
     main = "Insatisfechos", 
     xlab = "Arrival Delay in Minutes", 
     xlim = c(0, max(sample_datos$Arrival.Delay.in.Minutes, na.rm = TRUE)), 
     ylim = c(0, 0.04), 
     col = "blue", 
     border = "black")
```

```{r, echo=FALSE}
par(mfrow = c(1, 2), mar = c(5, 5, 4, 2), cex = 1.2)

# Filtrar los datos por nivel de satisfacción
departure_arrival_satisfecho <- sample_datos$Departure.Arrival.time.convenient[sample_datos$satisfaction == 1]
departure_arrival_insatisfecho <- sample_datos$Departure.Arrival.time.convenient[sample_datos$satisfaction == 0]

hist(departure_arrival_satisfecho, 
     probability = TRUE, 
     main = "Satisfechos", 
     xlab = "Departure arrival time convenient", 
     xlim = c(0, max(sample_datos$Departure.Arrival.time.convenient, na.rm = TRUE)), 
     ylim = c(0, 1), 
     col = "red", 
     border = "black")

# Histograma para los clientes insatisfechos
hist(departure_arrival_insatisfecho, 
     probability = TRUE, 
     main = "Insatisfechos", 
     xlab = "Departure arrival time convenient", 
     xlim = c(0, max(sample_datos$Departure.Arrival.time.convenient, na.rm = TRUE)), 
     ylim = c(0, 1), 
     col = "blue", 
     border = "black")
```

```{r, echo=FALSE}
par(mfrow = c(1, 2), mar = c(5, 5, 4, 2), cex = 1.2)

# Filtrar los datos por nivel de satisfacción
gate_satisfecho <- sample_datos$Gate.location[sample_datos$satisfaction == 1]
gate_insatisfecho <- sample_datos$Gate.location[sample_datos$satisfaction == 0]

hist(gate_satisfecho, 
     probability = TRUE, 
     main = "Satisfechos", 
     xlab = "Gate location", 
     xlim = c(0, max(sample_datos$Departure.Arrival.time.convenient, na.rm = TRUE)), 
     ylim = c(0, 2), 
     col = "red", 
     border = "black")

# Histograma para los clientes insatisfechos
hist(gate_insatisfecho, 
     probability = TRUE, 
     main = "Insatisfechos", 
     xlab = "Gate location", 
     xlim = c(0, max(sample_datos$Departure.Arrival.time.convenient, na.rm = TRUE)), 
     ylim = c(0, 2), 
     col = "blue", 
     border = "black")
```
Al graficar estas 4 variables, podemos ver que la ditribución entre pasajeros satisfechos e insatisfechos es muy similar por lo que concluimos que no impactan en lo que queremos predecir.

El siguiente grafico muestra la relación entre la variable "Type of Travel" y "satisfaction":
```{r, echo=FALSE}
library(ggplot2)
ggplot(data = sample_datos) +
  geom_histogram(mapping = aes(x = satisfaction, fill = Type.of.Travel),
                 colour = "black", binwidth = 0.5) +
  scale_fill_viridis_d() +
  facet_wrap(~ Type.of.Travel)
```
Se puede concluir que las personas que viajan por placer o temas personales suelen estar más insatisfechos que los que viajan por negocios. Viendo la distribución podemos ver que es una variable que realmente influye en lo que queremos predecir. 

En el siguiente histograma, queremos demostrar la relación entre la variable "Online boarding" y "satisfaction".
```{r, echo=FALSE}
par(mfrow = c(1, 2), mar = c(5, 5, 4, 2), cex = 1.2)

# Filtrar los datos por nivel de satisfacción
onlineb_satisfecho <- sample_datos$Online.boarding[sample_datos$satisfaction == 1]
onlineb_insatisfecho <- sample_datos$Online.boarding[sample_datos$satisfaction == 0]

hist(onlineb_satisfecho, 
     probability = TRUE, 
     main = "Satisfechos", 
     xlab = "Online boarding", 
     xlim = c(0, max(sample_datos$Online.boarding, na.rm = TRUE)), 
     ylim = c(0, 1), 
     col = "pink", 
     border = "black")

# Histograma para los clientes insatisfechos
hist(onlineb_insatisfecho, 
     probability = TRUE, 
     main = "Insatisfechos", 
     xlab = "Online boarding", 
     xlim = c(0, max(sample_datos$Online.boarding, na.rm = TRUE)), 
     ylim = c(0, 1), 
     col = "green", 
     border = "black")
```
Vemos que las distribuciones entre ambos son diferentes por lo que entendemos a "online boarding" como una variable influyente en la satisfacción del pasajero. Tiene sentido el grafico ya que los pasajeros satisfechos puntuan con una nota alta el online boarding mientras que los pasajeros insatisfechos puntuan con una nota más baja.

**3. Construcción de un árbol de decisión básico**

```{r}
entrenamiento <- sample_datos[1:35000,]
validacion <- sample_datos[35001:42500,]
testeo <- sample_datos[42501:50000,]

nrow(entrenamiento)
nrow(validacion)
nrow(testeo)
```

```{r}
library(rpart)
```

```{r}
tree <- rpart(formula = satisfaction ~ Flight.Distance + Inflight.wifi.service + Ease.of.Online.booking + Food.and.drink + Online.boarding + Seat.comfort + Inflight.entertainment + On.board.service + Leg.room.service + Baggage.handling + Checkin.service + Inflight.service + Cleanliness, 
              data = entrenamiento, 
              method = "class")
tree$control
```
Dentro de los hiperparametros que toma el árbol por defecto nos encontramos que minsplit, que es el número minimo de observaciones para que se pueda dividir un nodo, en este caso necesitamos un minimo de 20 observaciones. En cuanto a minbucket, que es el numero de minimo de observaciones en una hoja, nuestro arbol necesita 7 observaciones. Evita que las hojas del arbol tenga muy pocas observaciones y logra que no tengamos un modelo overfitted. El hiperparametro cp, es el parametro de complejidad para la poda del arbol. Es de 0.01 por lo que significa que una divisi;on en el arbol debe reducir en al menos 1% para ser considerada util. 
Maxdepth es la maxima produnfidad permitida para la construcción del árbol y en este caso, puede tener hasta 30 niveles.Cuanto más grande el árbol mejor se ajusta a los datos pero puede generar overfitting. Por otro lado, xval es el numero de grupos para validación cruzada.

```{r}
library(rpart.plot)
rpart.plot(tree)
```
En el nodo raiz encontramos el 100% de los datos y vemos que el 44% se corresponde con pasajeros satisfechos. El color del nodo no es tan intenso, por lo que el nodo es tan puro. Como la clase predominante es insatisfecho, el nodo contiene un 0. El factor mas importante para determinar la satisfacción del pasajero es el online boarding y divide a los datos a la mitad en un valor <4. Caen en dos nodos diferentes, donde uno predomina la insatisfacción al tener 15% de satisfacción y en el otro predomina la satisfaccion ya que tiene un nivel del 72%. Para el lado de insatisfacción podemos ver que inflight wifi service vuelve a dividir los datos y si es >4 cae en una hoja terminal en el cual los datos que caen alli son satisfechos. Vemos que el color no es muy puro pero si los datos caen allí lo predecira como un pasajero satisfecho. En caso contrario, cae en otro nodo que predominan los insatisfechos y los vuelve a dividir inflight wifi service >=1. Si cae allí, se predecira que el pasajero esta insatisfecho ya que solo 7% son satisfechos y predomina la clase de insatisfechos. El color del bodo nos muestra que es un nodo puro y el 44% de los datos de entrenamiento van a caer allí. Caso contrario, caerá en un nodo que predecirá al pasajero como satisfecho. Este es un nodo es completamente puro ya que el 100% de los datos que caen aca son satisfechos. 
Volviendo a la rama en donde el online boarding >4, la otra mitad de los datos caen en un primer nodo que predomina la satisfacción y luego los divide por Inflight entertainment. Si esta es <4, caen en un nodo donde predomina la clase insatisfecha y los divide por inflight wifi service. Si es >=5 cae en una hoja terminal de color muy puro ya que el 100% de los datos de entrenamiento que caen aca son pasajeros satisfechos. Si el inflight wifi service <5, cae en otro nodo que se divide por inflight wifi service >=1, cae en insatisfecho ya que solo el 34% de los datos son de pasajeros satisfechos. Sino, cae en un nodo completamente puro ya que el 100% de los datos son satisfechos.
Si el inflight entertainment es <=4, cae en un nodo donde predomina la clase satisfecha y de allí los divide por la variable leg room service. Si esta es >=4, cae en una hoja terminal en la que predomina la clase satisfecha. Esta hoja es de un color mayoritariamente puro ya que el 91% de los datos que caen aqui son de pasajeros satisfechos. Por el otro lado, si el leg room service <4 cae en un nodo donde mayoritariamente son pasajeros satisfechos. No obstante no es un nodo de color puro por lo que no se puede predecir con exactitud la conformidad del pasajero en cuanto al servicio brindado por la aerolinea. Asimismo, en este nodo se evalua que la varibale food and drink. Si esta es de <4, cae en una hoja terminal que no tiene un color puro porque solamente el 8% de los pasajeros estan satisfechos. Por ultimo, si food and drink >=4, cae en una hoja terminal no tan pura pero que predice como satisfechos el 71% de los pasajeros.

**4. Evaluación del árbol de decisión básico**

```{r}
predictions_clase <- predict(tree, newdata = testeo, type = "class")
predictions_prob <- predict(tree, newdata = testeo, type = "prob")
```

```{r}
#install.packages("MLmetrics")
library(MLmetrics)
```
```{r}
ConfusionMatrix(y_pred = predictions_clase, y_true = testeo$satisfaction)
```
```{r}
Accuracy(y_pred = predictions_clase, y_true = testeo$satisfaction)
```
```{r}
Precision(y_pred = predictions_clase, y_true = testeo$satisfaction)
Precision(y_pred = predictions_clase, y_true = testeo$satisfaction, positive = 1)
```
```{r}
Recall(y_pred = predictions_clase, y_true = testeo$satisfaction)
Recall(y_pred = predictions_clase, y_true = testeo$satisfaction, positive = 1)
```
```{r}
F1_Score(y_pred = predictions_clase, y_true = testeo$satisfaction)
F1_Score(y_pred = predictions_clase, y_true = testeo$satisfaction, positive = 1)
```
```{r}
AUC(y_pred = predictions_clase, y_true = testeo$satisfaction)
```
**5. Optimización del modelo**